# Otus Administrator Linux Professional


## Цель:
Создание рабочего проекта
веб проект с развертыванием нескольких виртуальных машин должен отвечать следующим требованиям:

* включен https;
* основная инфраструктура в DMZ зоне;
* файрвалл на входе;
* сбор метрик и настроенный алертинг;
* везде включен selinux;
* организован централизованный сбор логов.
* организован backup базы

## Сетевая схема инфраструктуры проекта

## Cписок серверов в проекте:

* inetRouter    - пограничный шлюз, фаервол, nginx proxy сервер, единая точка входа
* wordpress     - сервер включающий в себя хост машину, для приложений. На нем из Dockerfile разворачивается wordpress, а так же nginx сервер, на котором он работает
* mysql         - основной сервер баз данных сайта wordpress, мастер репликации
* mysqlslave    - slave-сервер репликации бд
* backup        - сервер-хранилище резервного копирования
* logserver     - центральный сервер сбора логов со всех серверов инфраструктуры
* monitoring    - центральный сервер мониторинга инфрастукруры, работает на zabbix 6.0

В качестве системы для всех виртуальных машин используется Vagrant "box centos/7", за исключением сервера мониторинга "bento/centos-stream-8"

## Развертывание инфраструктуры

После создания виртуальных машин по лекалам Vagrantfile, запускается общий плейбук для развертывания и настройки сервисов, состоящий и следующих ролей в следующем порядке:

1. Базовая установка репозиториев и ПО
2. Настройка шлюза 
3. Настройка серверов БД
4. Настройка сайта на вордпресс
5. Настройка сервера мониторинга
6. Настройка сервера логов
7. Настройка сервера бекапов

```
- name: project
  hosts: all
  gather_facts: true
  become: true
  roles:
    - setup

- name: project provision custom roles
  hosts: all
  gather_facts: true
  become: true

  tasks:
  - name: gateway provision
    include_role: name=gateway
    when: ansible_hostname == 'gateway'
    tags: gw

{...}

  - name: backup config provision
    include_role: name=backup
    when: config_backup == true
    tags: backup

```

### Для задания необходимых параметров используется файл group_vars\all.yml

### Для настройки сервера мониторинга из коллекции community.zabbix используются файлы с переменными для необходимой роли
пр. community.zabbix\roles\zabbix_server\defaults\main.yml

## Описание серверов и их функционала
### inetRouter
Шлюз по умолчанию для всех серверов, фаервол на основе firewalld, nginx сервер, переадресовывающий запросы на сервер вордпрес, по протоколу HTTPS, с самоподписанным сертификатом для обеспечения шифрования траффика


### Резервное копирование
Помимо репликации баз данных так же настроено резервное копирование некоторых директорий на серверах с помощью borgbackup
по умолчанию это папка /etc, для серверов mysql так же папка /var/bak, в которую ежедневно падает полный бекап бд с помощью xtrabackup

дополнительные папки задаются в inventory в паременной bak в кавычках и разделяются пробелом
пр.
``` 
bak_dir='/etc /var/log'
```
### Бекап и востановление с помощью xtrabackup


### Сервер мониторинга 
работает на zabbix 6.0, устанавливается согласно инструкции в коллекции community.zabbix
Для получения доступа к нему нужно заходить на сайт zabbix.example.com из локальной сети инфраструктуры, имя предварительно настраивается на всех машинах в /etc/hosts с помощью ansible
Так же при желании на бастионе в конфиге nginx добавляется location с описанием редиректа на фактическимй сервер, для простоты доступа

```
# zabbix
   server {
        listen       80;
        listen       [::]:80;
        server_name  zabbix.example.com;
        root         /usr/share/nginx/html;

        # Load configuration files for the default server block.
        include /etc/nginx/default.d/*.conf;


        location / {
        proxy_pass http://10.10.20.50;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        }

```

Дополнительно на нем настроен алертинг для отправки сообщений об ошибках администраторам, при условии того что их почта сконфигурирована в веб интерфейсе
В данном примере использована реальная почта another-che@yandex.ru

### Сервер логов 
работает на основе rsyslog, все логи со всех машин падают на него
