# Otus Administrator Linux Professional


## Цель:
Создание рабочего проекта
веб проект с развертыванием нескольких виртуальных машин должен отвечать следующим требованиям:

* включен https;
* основная инфраструктура в DMZ зоне;
* файрвалл на входе;
* сбор метрик и настроенный алертинг;
* везде включен selinux;
* организован централизованный сбор логов.
* организован backup базы

## Сетевая схема инфраструктуры проекта

## Cписок серверов в проекте:

* inetRouter    - пограничный шлюз, фаервол, nginx proxy сервер, единая точка входа
* wordpress     - сервер включающий в себя хост машину, для приложений. На нем из Dockerfile разворачивается wordpress, а так же nginx сервер, на котором он работает
* mysql         - основной сервер баз данных сайта wordpress, мастер репликации
* mysqlslave    - slave-сервер репликации бд
* backup        - сервер-хранилище резервного копирования
* logserver     - центральный сервер сбора логов со всех серверов инфраструктуры
* monitoring    - центральный сервер мониторинга инфрастукруры, работает на zabbix 6.0

В качестве системы для всех виртуальных машин используется Vagrant "box centos/7", за исключением сервера мониторинга "bento/centos-stream-8"

## Развертывание инфраструктуры

После создания виртуальных машин по лекалам Vagrantfile, запускается общий плейбук для развертывания и настройки сервисов, состоящий и следующих ролей в следующем порядке:

1. Базовая установка репозиториев и ПО
2. Настройка шлюза 
3. Настройка серверов БД
4. Настройка сайта на вордпресс
5. Настройка сервера мониторинга
6. Настройка сервера логов
7. Настройка сервера бекапов

```
- name: project
  hosts: all
  gather_facts: true
  become: true
  roles:
    - setup

- name: project provision custom roles
  hosts: all
  gather_facts: true
  become: true

  tasks:
  - name: gateway provision
    include_role: name=gateway
    when: ansible_hostname == 'gateway'
    tags: gw

{...}

  - name: backup config provision
    include_role: name=backup
    when: config_backup == true
    tags: backup

```

### Для задания необходимых параметров используется файл group_vars\all.yml

### Для настройки сервера мониторинга из коллекции community.zabbix используются файлы с переменными для необходимой роли
пр. community.zabbix\roles\zabbix_server\defaults\main.yml

### Резервное копирование
Помимо репликации баз данных так же настроено резервное копирование некоторых директорий на серверах с помощью borgbackup
по умолчанию это папка /etc, для серверов mysql так же папка /var/bak, в которую ежедневно падает полный бекап бд с помощью xtrabackup

дополнительные папки задаются в inventory в паременной bak и разделяются экранированным пробелом
пр.
``` bak_dir=/etc\ /var/log
```

### Сервер логов 
работает на основе rsyslog, все логи со всех машин падают на него