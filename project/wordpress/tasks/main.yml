---
# tasks file for wordpress
  - name: install epel repo
    yum:
      name:
        - epel-release
      state: present
      update_cache: true


  - name: install soft
    yum:
      name:
        - nginx
        - snapd
        - policycoreutils-python
        - php 
        - php-cli 
        - mod_fcgid
        - php-fpm
      state: present
      update_cache: true


  - name: Check if WordPress directory exists in
    stat: path="{{ webroot }}/wordpress/wp-config-sample.php"
    register: check_path


  - name: Download WordPress
    get_url:
      url: https://wordpress.org/latest.tar.gz
      dest: /tmp/wordpress.tar.gz
      #checksum: "sha1:{{ wp_sha1sum }}"
    become: yes
    when: not check_path.stat.exists

  - name: Extract WordPress
    unarchive:
      src: /tmp/wordpress.tar.gz
      dest: /tmp
      owner: nginx
      group: nginx
      copy: no
    become: yes
    when: not check_path.stat.exists

  - name: Move WordPress install files
    command: mv /tmp/wordpress "{{ webroot }}"
    become: yes
    when: not check_path.stat.exists

  - name: set context
    sefcontext:
      target: "{{ webroot }}{{server_hostname}}"
      setype: httpd_sys_content_t
      seuser: system_u
      state: present
    when: not check_path.stat.exists

  - name: Fetch random salts for WordPress config
    local_action: command curl https://api.wordpress.org/secret-key/1.1/salt/
    register: "wp_salt"
    become: no

  - name: Add wp-config
    template: "src=wp-config.php dest={{ webroot }}/wp-config.php"
    become: yes

  - name: Update WordPress config file
    lineinfile:
      dest: "{{ webroot }}/wp-config.php"
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
    with_items:
      - {'regexp': "define\\('DB_NAME', '(.)+'\\);", 'line': "define('DB_NAME', '{{wp_db_name}}');"}
      - {'regexp': "define\\('DB_USER', '(.)+'\\);", 'line': "define('DB_USER', '{{wp_db_user}}');"}
      - {'regexp': "define\\('DB_PASSWORD', '(.)+'\\);", 'line': "define('DB_PASSWORD', '{{wp_db_password}}');"}
      - {'regexp': "define\\('DB_HOST', '(.)+'\\);", 'line': "define('DB_HOST', '{{wp_db_host}}');"}
    become: yes

  - name: change root to wordpress
    shell: sed -i "/root/ s/html/wordpress/g" /etc/nginx/nginx.conf

  - name: restart-nginx
    service:
      name: nginx
      state: restarted
    become: yes

