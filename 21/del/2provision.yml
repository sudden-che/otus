---
- hosts: pxeserver
  gather_facts: true
  become: true

  tasks:

#      - name: set up repo
#        replace:
#          path: "{{ item }}"
#          regexp: 'mirrorlist'
#          replace: '#mirrorlist'
#        with_items:
#          - /etc/yum.repos.d/CentOS-Linux-AppStream.repo
#          - /etc/yum.repos.d/CentOS-Linux-BaseOS.repo
#

#      - name: set up repo
#        replace:
#          path: "{{ item }}"
#          regexp: '#baseurl=http://mirror.centos.org'
#          replace: 'baseurl=http://vault.centos.org'
#        with_items:
#          - /etc/yum.repos.d/CentOS-Linux-AppStream.repo
#          - /etc/yum.repos.d/CentOS-Linux-BaseOS.repo

#Извлекаем файлы из RPM-пакета
      - name: extract packages syslinux
        shell: rpm2cpio /iso/BaseOS/Packages/syslinux-tftpboot-6.04-5.el8.noarch.rpm | cpio -dimv

#Копируем файлы в каталог /var/lib/tftpboot/
      - name: copy files to TFTP share
        copy:
          src: /home/vagrant/tftpboot/{{ item }}
          dest: /var/lib/tftpboot/{{ item }}
          mode: '0644'
          remote_src: true
        with_items:
          - pxelinux.0
          - ldlinux.c32
          - libmenu.c32
          - libutil.c32
          - menu.c32
          - vesamenu.c32

#Копируем файлы в каталог /var/lib/tftpboot/
      - name: copy initrd and vmlinuz files to TFTP share
        copy:
          src: /iso/images/pxeboot/{{ item }}
          dest: /var/lib/tftpboot/{{ item }}
          mode: '0755'
          remote_src: true
        with_items:
          - initrd.img
          - vmlinuz

#Перезапускаем TFTP-сервер и добавляем его в автозагрузку
      - name: restart tftp-server
        service:
          name: tftp.service
          state: restarted
          enabled: true
      
#Копирование файла конфигурации DHCP-сервера
      - name: set up dhcp-server
        template:
          src: dhcpd.conf
          dest: /etc/dhcp/dhcpd.conf
          mode: '0644'

#Перезапуск службы и добавление в автозагрузку
      - name: restart dhcp-server
        service:
          name: dhcpd
          state: restarted
          enabled: true

# добавляем kickstart-file на вебсервер
      - name: copy ks.cfg
        template:
          src: ks.cfg
          dest: /iso/ks.cfg
          owner: root
          group: root
          mode: 0755   



